#!/bin/bash
# Runtipi Auto-Installation Script

RUNTIPI_DIR="$HOME/runtipi"
INSTALL_FLAG="$HOME/.runtipi-installed"
LOG_FILE="/tmp/runtipi-install.log"

# Ensure we run in the user's home and have a sane environment
cd "$HOME" || cd /
export DEBIAN_FRONTEND=noninteractive
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"

# Function to log with timestamp
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Exit if already installed
if [ -f "$INSTALL_FLAG" ]; then
    log "Runtipi already installed at $RUNTIPI_DIR"
    exit 0
fi

log "========================================="
log "  Runtipi Auto-Installation Starting"
log "========================================="

# Wait for internet (double check with timeout)
log "Checking internet connectivity..."
MAX_TRIES=12
TRIES=0

while [ $TRIES -lt $MAX_TRIES ]; do
    if ping -c 1 -W 2 8.8.8.8 &>/dev/null || ping -c 1 -W 2 1.1.1.1 &>/dev/null; then
        log "Internet connection confirmed!"
        break
    fi
    TRIES=$((TRIES + 1))
    log "Attempt $TRIES/$MAX_TRIES - Waiting for internet..."
    sleep 10
done

if [ $TRIES -eq $MAX_TRIES ]; then
    log "ERROR: No internet connection after $MAX_TRIES attempts"
    log "Installation will retry on next boot"
    exit 1
fi

# Additional wait to ensure network is fully ready
log "Waiting 10 seconds for network stabilization..."
sleep 10

# Install Runtipi using official installer
log "Downloading and installing Runtipi..."
log "This will install Docker, Docker Compose, and Runtipi"
log "This may take 10-30 minutes depending on your connection..."
log "Installation log: $LOG_FILE"

# Download and run installer with error handling
if command -v curl >/dev/null 2>&1; then
    log "curl found"
else
    log "ERROR: curl is not installed"
    exit 1
fi

if curl -fsSL https://setup.runtipi.io -o /tmp/runtipi-installer.sh 2>>"$LOG_FILE"; then
    log "Installer downloaded successfully"
    log "Running installation script..."
    
    if bash /tmp/runtipi-installer.sh >> "$LOG_FILE" 2>&1; then
        # Mark as installed
        touch "$INSTALL_FLAG"
        
        log "========================================="
        log "  Runtipi Installation Complete!"
        log "========================================="
        log ""
        log "Access Runtipi at:"
        log "  http://runtipios.local"
        log "  http://$(hostname -I | awk '{print $1}')"
        log ""
        
        # Cleanup
        rm -f /tmp/runtipi-installer.sh
        
        exit 0
    else
        log "ERROR: Runtipi installation script failed"
        log "Check logs: cat $LOG_FILE"
        log "Retry manually: curl -L https://setup.runtipi.io | bash"
        exit 1
    fi
else
    log "ERROR: Failed to download Runtipi installer"
    log "Check internet connection and try again"
    exit 1
fi
