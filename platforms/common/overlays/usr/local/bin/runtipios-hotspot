#!/bin/bash
# RuntipiOS WiFi Hotspot Management Script

INTERFACE="wlan0"
SSID="RuntipiOS-Setup"
PASSWORD="runtipios2024"
CHANNEL=6
SUBNET="192.168.42"
LOG_FILE="/tmp/runtipios-hotspot.log"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

start_hotspot() {
    log "=== Starting WiFi hotspot: $SSID ==="
    
    # Check if interface exists
    if ! ip link show $INTERFACE &>/dev/null; then
        log "ERROR: Interface $INTERFACE not found"
        log "Available interfaces:"
        ip link show | grep -E '^[0-9]+:' | tee -a "$LOG_FILE"
        exit 1
    fi
    
    log "Interface $INTERFACE found"
    
    # Wait a bit for network to stabilize
    log "Waiting 5 seconds for network stabilization..."
    sleep 5
    
    # Check if Ethernet cable is physically connected (carrier detected)
    ETH_CONNECTED=false
    for eth_if in eth0 end0 enp* enx*; do
        if [ -d "/sys/class/net/$eth_if" ] 2>/dev/null; then
            if [ -f "/sys/class/net/$eth_if/carrier" ]; then
                carrier=$(cat /sys/class/net/$eth_if/carrier 2>/dev/null || echo 0)
                log "Checking $eth_if: carrier=$carrier"
                if [ "$carrier" = "1" ]; then
                    log "Ethernet cable detected on $eth_if - hotspot not needed"
                    ETH_CONNECTED=true
                    break
                fi
            fi
        fi
    done
    
    # Also check if WiFi is already configured
    if [ -f "/etc/wpa_supplicant/wpa_supplicant-wlan0.conf" ]; then
        log "WiFi already configured - hotspot not needed"
        exit 1  # Return error to prevent service from staying active
    fi
    
    if [ "$ETH_CONNECTED" = true ]; then
        log "Ethernet connection available, skipping hotspot activation"
        exit 1  # Return error to prevent service from staying active
    fi
    
    log "No Ethernet or WiFi configured - activating WiFi hotspot"
    
    # Unblock WiFi if blocked
    log "Unblocking WiFi..."
    rfkill unblock wifi 2>/dev/null || true
    
    # Stop conflicting services
    log "Stopping conflicting services (wpa_supplicant, dnsmasq, NetworkManager, dhcpcd)..."
    systemctl stop wpa_supplicant@wlan0 2>/dev/null || true
    systemctl stop dnsmasq 2>/dev/null || true
    systemctl stop NetworkManager 2>/dev/null || true
    systemctl stop dhcpcd 2>/dev/null || true
    
    # Kill any existing processes
    killall wpa_supplicant 2>/dev/null || true
    killall dnsmasq 2>/dev/null || true
    killall dhcpcd 2>/dev/null || true
    
    # Configure interface
    log "Configuring interface $INTERFACE..."
    ip link set dev $INTERFACE down
    sleep 1
    ip addr flush dev $INTERFACE
    ip addr add ${SUBNET}.1/24 dev $INTERFACE
    ip link set dev $INTERFACE up
    sleep 2
    
    log "Interface configured with IP ${SUBNET}.1"
    
    # Mark hotspot as active for other components (e.g., captive portal)
    mkdir -p /run/runtipios
    echo on > /run/runtipios/hotspot.active
    
    # Configure hostapd
    log "Configuring hostapd..."
    cat > /etc/hostapd/hostapd.conf << EOF
interface=$INTERFACE
driver=nl80211
ssid=$SSID
hw_mode=g
channel=$CHANNEL
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=$PASSWORD
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
rsn_pairwise=CCMP
country_code=FR
ieee80211n=1
ieee80211d=1
EOF
    
    # Configure dnsmasq
    log "Configuring dnsmasq..."
    cat > /etc/dnsmasq.d/hotspot.conf << EOF
interface=$INTERFACE
bind-interfaces
dhcp-range=${SUBNET}.10,${SUBNET}.250,255.255.255.0,24h
dhcp-option=3,${SUBNET}.1
dhcp-option=6,${SUBNET}.1
server=8.8.8.8
listen-address=${SUBNET}.1
address=/#/${SUBNET}.1
no-resolv
log-queries
log-dhcp
EOF
    
    # Start services
    log "Starting hostapd..."
    hostapd -B /etc/hostapd/hostapd.conf 2>&1 | tee -a "$LOG_FILE"
    HOSTAPD_EXIT=$?
    
    if [ $HOSTAPD_EXIT -eq 0 ]; then
        log "hostapd started successfully"
    else
        log "ERROR: hostapd failed with exit code $HOSTAPD_EXIT"
        log "Check hostapd configuration and WiFi driver"
        exit 1
    fi
    
    sleep 3
    
    log "Starting dnsmasq..."
    dnsmasq --conf-file=/etc/dnsmasq.d/hotspot.conf 2>&1 | tee -a "$LOG_FILE"
    DNSMASQ_EXIT=$?
    
    if [ $DNSMASQ_EXIT -eq 0 ]; then
        log "dnsmasq started successfully"
    else
        log "ERROR: dnsmasq failed with exit code $DNSMASQ_EXIT"
        log "Stopping hostapd..."
        killall hostapd
        exit 1
    fi
    
    log "Starting web server..."
    systemctl start lighttpd 2>&1 | tee -a "$LOG_FILE"
    
    log "=== Hotspot started successfully ==="
    log "SSID: $SSID"
    log "Password: $PASSWORD"
    log "Web portal: http://${SUBNET}.1"
    
    # Keep running (don't exit) - minimal heartbeat loop
    log "Hotspot is running. Press Ctrl+C or stop service to exit."
    while sleep 60; do :; done
}
}

stop_hotspot() {
    log "=== Stopping WiFi hotspot ==="
    killall hostapd 2>/dev/null || true
    killall dnsmasq 2>/dev/null || true
    systemctl stop lighttpd 2>/dev/null || true
    rm -f /etc/hostapd/hostapd.conf
    rm -f /etc/dnsmasq.d/hotspot.conf
    ip addr flush dev $INTERFACE 2>/dev/null || true
    ip link set dev $INTERFACE down 2>/dev/null || true
    rm -f /run/runtipios/hotspot.active
    log "Hotspot stopped"
}

case "$1" in
    start) start_hotspot ;;
    stop) stop_hotspot ;;
    restart) stop_hotspot; sleep 2; start_hotspot ;;
    *) echo "Usage: $0 {start|stop|restart}"; exit 1 ;;
esac
