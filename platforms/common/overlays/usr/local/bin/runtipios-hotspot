#!/bin/bash
# RuntipiOS WiFi Hotspot Management Script

INTERFACE="wlan0"
SSID="RuntipiOS-Setup"
PASSWORD="runtipios2024"
CHANNEL=6
SUBNET="192.168.42"

start_hotspot() {
    echo "Starting WiFi hotspot: $SSID"
    
    # Check if interface exists
    if ! ip link show $INTERFACE &>/dev/null; then
        echo "Error: Interface $INTERFACE not found"
        exit 1
    fi
    
    # Check if Ethernet is connected - DO NOT start hotspot if Ethernet is available
    ETH_CONNECTED=false
    for eth_if in eth0 end0; do
        if ip link show $eth_if 2>/dev/null | grep -q "state UP"; then
            echo "Ethernet interface $eth_if is connected - hotspot not needed"
            ETH_CONNECTED=true
            break
        fi
    done
    
    if [ "$ETH_CONNECTED" = true ]; then
        echo "Ethernet connection available, skipping hotspot activation"
        exit 0
    fi
    
    echo "No Ethernet detected, activating WiFi hotspot"
    
    # Unblock WiFi if blocked
    rfkill unblock wifi 2>/dev/null || true
    
    # Stop conflicting services
    systemctl stop wpa_supplicant@wlan0 2>/dev/null || true
    systemctl stop dhcpcd 2>/dev/null || true
    
    # Kill any existing processes
    killall wpa_supplicant 2>/dev/null || true
    killall dhcpcd 2>/dev/null || true
    
    # Configure interface
    ip link set dev $INTERFACE down
    sleep 1
    ip addr flush dev $INTERFACE
    ip addr add ${SUBNET}.1/24 dev $INTERFACE
    ip link set dev $INTERFACE up
    sleep 2
    
    # Configure hostapd
    cat > /etc/hostapd/hostapd.conf << EOF
interface=$INTERFACE
driver=nl80211
ssid=$SSID
hw_mode=g
channel=$CHANNEL
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=$PASSWORD
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
rsn_pairwise=CCMP
country_code=FR
ieee80211n=1
ieee80211d=1
EOF
    
    # Configure dnsmasq
    cat > /etc/dnsmasq.d/hotspot.conf << EOF
interface=$INTERFACE
bind-interfaces
dhcp-range=${SUBNET}.10,${SUBNET}.250,255.255.255.0,24h
dhcp-option=3,${SUBNET}.1
dhcp-option=6,${SUBNET}.1
server=8.8.8.8
listen-address=${SUBNET}.1
address=/#/${SUBNET}.1
no-resolv
log-queries
log-dhcp
EOF
    
    # Start services
    echo "Starting hostapd..."
    hostapd -B /etc/hostapd/hostapd.conf
    sleep 2
    
    echo "Starting dnsmasq..."
    dnsmasq --conf-file=/etc/dnsmasq.d/hotspot.conf
    
    echo "Starting web server..."
    systemctl start lighttpd 2>/dev/null || true
    
    echo "Hotspot started: $SSID / $PASSWORD"
    echo "Web portal: http://${SUBNET}.1"
}

stop_hotspot() {
    echo "Stopping WiFi hotspot"
    killall hostapd 2>/dev/null || true
    killall dnsmasq 2>/dev/null || true
    systemctl stop lighttpd 2>/dev/null || true
    rm -f /etc/hostapd/hostapd.conf
    rm -f /etc/dnsmasq.d/hotspot.conf
    ip addr flush dev $INTERFACE 2>/dev/null || true
    ip link set dev $INTERFACE down 2>/dev/null || true
}

case "$1" in
    start) start_hotspot ;;
    stop) stop_hotspot ;;
    restart) stop_hotspot; sleep 2; start_hotspot ;;
    *) echo "Usage: $0 {start|stop|restart}"; exit 1 ;;
esac
