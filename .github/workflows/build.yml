name: Build RuntipiOS Image

on:
  workflow_dispatch:

jobs:
  build-image:
    runs-on: ubuntu-latest
    env:
      IMAGE_DIR: ${{ github.workspace }}/images
      RUNTIPIOS_DIR: ${{ github.workspace }}/runtipios

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          # Add tools for loop/partition mapping and filesystem handling
          sudo apt-get install -y wget xz-utils rsync parted kpartx dosfstools e2fsprogs

      - name: Create images directory
        run: mkdir -p $IMAGE_DIR

      - name: Read base image URL from config
        id: readconfig
        run: |
          IMG_URL=$(grep 'url:' $RUNTIPIOS_DIR/config.yml | awk '{print $2}' | tr -d '"')
          echo "IMG_URL=$IMG_URL" >> $GITHUB_ENV
          IMG_NAME=$(basename $IMG_URL)
          echo "IMG_NAME=$IMG_NAME" >> $GITHUB_ENV

      - name: Download base Raspberry Pi OS image
        run: wget -O $IMAGE_DIR/$IMG_NAME $IMG_URL

      - name: Verify downloaded image
        run: |
          echo "Listing $IMAGE_DIR"
          ls -lh $IMAGE_DIR || true
          echo "file:"; file $IMAGE_DIR/$IMG_NAME || true
          echo "xz list:"; xz -l $IMAGE_DIR/$IMG_NAME || true
          echo "sha256:"; sha256sum $IMAGE_DIR/$IMG_NAME || true

      - name: Decompress base image
        run: |
          if [ ! -f "$IMAGE_DIR/$IMG_NAME" ]; then
            echo "ERROR: $IMAGE_DIR/$IMG_NAME not found after download"
            ls -l $IMAGE_DIR || true
            exit 1
          fi
          echo "Decompressing $IMAGE_DIR/$IMG_NAME to $IMAGE_DIR/raspios.img"
          sudo apt-get install -y xz-utils || true
          xz -d -k -c "$IMAGE_DIR/$IMG_NAME" > "$IMAGE_DIR/raspios.img"
          echo "Decompressed file:"; ls -lh $IMAGE_DIR/raspios.img || true


      - name: Mount image and map partitions
        id: mountimage
        run: |
          mkdir -p mnt mnt/boot
          # Create a loop device and have the kernel create partition devices (e.g. /dev/loop0p1)
          LOOPDEV=$(sudo losetup --find --show -P $IMAGE_DIR/raspios.img)
          echo "LOOPDEV=$LOOPDEV" >> $GITHUB_ENV
          # Common Raspberry Pi images have p1=boot (FAT) and p2=root (ext4)
          BOOT_PART=${LOOPDEV}p1
          ROOT_PART=${LOOPDEV}p2
          echo "BOOT_PART=$BOOT_PART" >> $GITHUB_ENV
          echo "ROOT_PART=$ROOT_PART" >> $GITHUB_ENV
          # Wait a moment for devices to appear
          sudo sleep 1
          # Sanity checks: show partition layout and ensure expected partition nodes exist
          echo "lsblk:"; lsblk || true
          echo "parted:"; sudo parted -s $IMAGE_DIR/raspios.img unit s print || true
          if [ ! -b "$ROOT_PART" ] || [ ! -b "$BOOT_PART" ]; then
            echo "ERROR: expected partition block devices not found: $BOOT_PART $ROOT_PART"
            ls -l /dev | grep $(basename $LOOPDEV) || true
            exit 1
          fi
          sudo mount $ROOT_PART mnt
          sudo mount $BOOT_PART mnt/boot

      - name: Copy RuntipiOS files
        run: |
          sudo rsync -a $RUNTIPIOS_DIR/scripts mnt/opt/runtipi-hotspot/
          sudo rsync -a $RUNTIPIOS_DIR/www mnt/opt/runtipi-hotspot/
          sudo cp $RUNTIPIOS_DIR/config.yml mnt/opt/runtipi-hotspot/

      - name: Setup userconf.txt
        run: sudo bash mnt/opt/runtipi-hotspot/scripts/00-setup-userconf.sh mnt/boot mnt/opt/runtipi-hotspot/config.yml

      - name: Setup hotspot dependencies in chroot
        run: |
          # Bind mount necessary system directories for chroot
          sudo mount --bind /dev mnt/dev
          sudo mount --bind /proc mnt/proc
          sudo mount --bind /sys mnt/sys
          sudo mount --bind /dev/pts mnt/dev/pts
          
          # Make scripts executable
          sudo chmod +x mnt/opt/runtipi-hotspot/scripts/*.sh
          sudo chmod +x mnt/opt/runtipi-hotspot/scripts/*.py
          
          # Run hotspot setup script in chroot to install dependencies
          echo "Installing hotspot dependencies..."
          sudo chroot mnt /bin/bash -c "cd /opt/runtipi-hotspot/scripts && bash 10-setup-hotspot.sh"
          
          # Verify installations
          echo "Verifying installed packages..."
          sudo chroot mnt /bin/bash -c "dpkg -l | grep -E 'nginx|dnsmasq|hostapd|python3'" || true

      - name: Install and enable systemd services
        run: |
          # Copy service files
          sudo cp mnt/opt/runtipi-hotspot/scripts/runtipi-*.service mnt/etc/systemd/system/
          
          # Verify service files are present
          echo "Service files installed:"
          ls -la mnt/etc/systemd/system/runtipi-*.service
          
          # Enable services using systemctl in chroot
          echo "Enabling runtipi-wifi.service..."
          sudo chroot mnt systemctl enable runtipi-wifi.service
          
          # Note: runtipi-hotspot.service is started conditionally by detect-network.sh
          # but we ensure it's available
          echo "Services enabled:"
          sudo chroot mnt systemctl list-unit-files | grep runtipi || true
          
          # Unmount chroot binds
          sudo umount mnt/dev/pts || true
          sudo umount mnt/sys || true
          sudo umount mnt/proc || true
          sudo umount mnt/dev || true

      - name: Unmount partitions and detach loop devices
        if: always()
        run: |
          sudo umount mnt/boot || true
          sudo umount mnt || true
          # Detach loop device if set
          if [ -n "$LOOPDEV" ]; then
            sudo losetup -d $LOOPDEV || true
          else
            # Fallback: try to detach LOOP_BOOT/LOOP_ROOT if present
            [ -n "$LOOP_BOOT" ] && sudo losetup -d $LOOP_BOOT || true
            [ -n "$LOOP_ROOT" ] && sudo losetup -d $LOOP_ROOT || true
          fi

      - name: Compress final image
        run: |
          # Fail early with a helpful message if the image isn't present
          if [ ! -f "$IMAGE_DIR/raspios.img" ]; then
            echo "ERROR: $IMAGE_DIR/raspios.img not found"
            ls -l $IMAGE_DIR || true
            exit 1
          fi
          # Compress explicitly to the target filename to avoid mv race conditions
          xz -T0 -c $IMAGE_DIR/raspios.img > $IMAGE_DIR/runtipios.img.xz
          ls -lh $IMAGE_DIR

      - name: Upload compressed image
        uses: actions/upload-artifact@v4
        with:
          name: runtipios-image
          path: ${{ env.IMAGE_DIR }}/runtipios.img.xz
