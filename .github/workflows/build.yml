name: "Build RuntipiOS"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      buildroot_version:
        description: "Buildroot version/branch"
        default: "2024.08.x"
        required: false

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        board:
          - runtipios_rpi4_64
          - runtipios_rpi5_64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential git curl wget bc rsync \
            binutils bison flex unzip libssl-dev libffi-dev \
            perl python3 cpio patchelf file lzop \
            device-tree-compiler u-boot-tools

      - name: Clone Buildroot
        run: |
          BUILDROOT_VERSION="${{ github.event.inputs.buildroot_version || '2024.08.x' }}"
          git clone --depth=1 --branch "$BUILDROOT_VERSION" \
            https://github.com/buildroot/buildroot.git buildroot

      - name: Cache Buildroot downloads
        uses: actions/cache@v4
        with:
          path: buildroot/dl
          key: buildroot-dl-${{ runner.os }}-${{ matrix.board }}-${{ hashFiles('configs/*_defconfig') }}
          restore-keys: |
            buildroot-dl-${{ runner.os }}-${{ matrix.board }}-
            buildroot-dl-${{ runner.os }}-

      - name: Configure Buildroot
        run: |
          cd buildroot
          export BR2_EXTERNAL=$(pwd)/..
          make ${{ matrix.board }}_defconfig
          echo "Configuration loaded successfully"

      - name: Build image
        run: |
          cd buildroot
          echo "Building RuntipiOS for ${{ matrix.board }}..."
          make -j$(nproc) 2>&1 | tee build.log
          echo "Build completed!"

      - name: Package artifacts
        if: success()
        run: |
          mkdir -p artifacts
          
          # Copy image
          if [ -f buildroot/output/images/sdcard.img ]; then
            cp buildroot/output/images/sdcard.img artifacts/runtipios-${{ matrix.board }}-${{ github.run_number }}.img
            gzip artifacts/runtipios-${{ matrix.board }}-${{ github.run_number }}.img
          fi
          
          # Copy build info
          cat > artifacts/build-info.txt << EOF
          RuntipiOS Build Information
          ===========================
          Board: ${{ matrix.board }}
          Build Number: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          Date: $(date -u)
          Buildroot Version: ${{ github.event.inputs.buildroot_version || '2024.08.x' }}
          EOF
          
          ls -lh artifacts/

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: runtipios-${{ matrix.board }}-${{ github.run_number }}
          path: artifacts/*
          retention-days: 30

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.board }}-${{ github.run_number }}
          path: buildroot/build.log
          retention-days: 7

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/') && success()
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          body: |
            RuntipiOS Release - ${{ matrix.board }}
            
            **Flash instructions:**
            ```bash
            # Download the .img.gz file
            # Flash to SD card:
            gunzip -c runtipios-*.img.gz | sudo dd of=/dev/sdX bs=4M status=progress
            ```
            
            See [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) for full documentation.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
