name: Build RuntipiOS Image

on:
  # Allows manual triggering from the Actions tab
  workflow_dispatch:

  # Triggers on new release creation
  release:
    types: [created]

jobs:
  build-image:
    runs-on: ubuntu-latest
    env:
      WORKSPACE: ${{ github.workspace }}
      CONFIG_FILE: ${{ github.workspace }}/config.yml
      IMAGE_DIR: ${{ github.workspace }}/images

    steps:
      - uses: actions/checkout@v4

      - name: Parse config.yml with Python
        id: config
        run: |
          pip install pyyaml
          python -c "
          import yaml
          import os

          with open('config.yml', 'r') as f:
              config = yaml.safe_load(f)

          # Extract image name from URL
          raspios_url = config['raspios']['url']
          image_name = raspios_url.split('/')[-1]

          with open(env_file, 'a') as f:
              f.write(f\"RASPIOS_IMAGE_URL={raspios_url}\n\")
              f.write(f\"RASPIOS_IMAGE_NAME={image_name}\n\")
              f.write(f\"HOSTNAME={config['system']['hostname']}\n\")
              f.write(f\"TIMEZONE={config['system']['timezone']}\n\")
              f.write(f\"LOCALE={config['system']['locale']}\n\")
              f.write(f\"KEYBOARD_LAYOUT={config['system']['keyboard_layout']}\n\")
              f.write(f\"WIFI_COUNTRY={config['system']['wifi_country']}\n\")
              f.write(f\"DEFAULT_USER={config['system']['default_user']}\n\")
              f.write(f\"DEFAULT_PASSWORD={config['system']['default_password']}\n\")
              f.write(f\"AUTOLOGIN={config['system'].get('autologin', True)}\n\")
              f.write(f\"SHOW_MOTD={config['system'].get('show_motd', True)}\n\")
              f.write(f\"IMAGE_SIZE={config['build']['image_size']}\n\")
              f.write(f\"COMPRESSION_FORMAT={config['build']['compression_format']}\n\")
              f.write(f\"RUNTIPI_AUTO_INSTALL={config['runtipi']['auto_install']}\n\")
              f.write(f\"RUNTIPI_URL={config['runtipi']['url']}\n\")
          "

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xz-utils rsync parted kpartx dosfstools e2fsprogs qemu-user-static binfmt-support util-linux openssl

      - name: Prepare images dir
        run: mkdir -p $IMAGE_DIR

      - name: Download base Raspberry Pi OS image
        run: |
          echo "Downloading ${{ env.RASPIOS_IMAGE_URL }} to ${{ env.IMAGE_DIR }}"
          wget -O ${{ env.IMAGE_DIR }}/raspios.img.xz "${{ env.RASPIOS_IMAGE_URL }}"

      - name: Decompress base image
        run: |
          if [ ! -f "${{ env.IMAGE_DIR }}/raspios.img.xz" ]; then
            echo "ERROR: downloaded image missing"
            ls -l ${{ env.IMAGE_DIR }}
            exit 1
          fi
          xz -d -k -c "${{ env.IMAGE_DIR }}/raspios.img.xz" > "${{ env.IMAGE_DIR }}/raspios.img"
          ls -lh ${{ env.IMAGE_DIR }}

      - name: Resize image file if requested
        run: |
          IMG="${{ env.IMAGE_DIR }}/raspios.img"
          if [ -z "${{ env.IMAGE_SIZE }}" ]; then
            echo "No build.image_size provided, keeping base image size"
            exit 0
          fi
          # Convert size like "4G" to bytes
          SIZE_VALUE=$(echo "${{ env.IMAGE_SIZE }}" | sed 's/[^0-9]//g')
          BYTES=$(( ${SIZE_VALUE} * 1024 * 1024 * 1024 ))
          CUR=$(stat -c%s "$IMG")
          echo "Current size: $CUR bytes, desired: $BYTES bytes"
          if [ "$CUR" -lt "$BYTES" ]; then
            echo "Expanding image to ${{ env.IMAGE_SIZE }}"
            truncate -s $BYTES "$IMG"
          else
            echo "Image is already >= desired size"
          fi

      - name: Setup loop device and map partitions
        run: |
          IMG="${{ env.IMAGE_DIR }}/raspios.img"
          LOOPDEV=$(sudo losetup --find --show -P "$IMG")
          echo "LOOPDEV=$LOOPDEV" >> $GITHUB_ENV
          sleep 1
          echo "Partitions:"
          ls -l ${LOOPDEV}* || true

      - name: Resize root partition to fill image
        run: |
          LOOPDEV=${{ env.LOOPDEV }}
          # try to resize partition 2 to 100%
          sudo parted -s $LOOPDEV resizepart 2 100% || true
          # run e2fsck and resize2fs on the partition device
          ROOTPART=${LOOPDEV}p2
          if [ ! -b "$ROOTPART" ]; then
            echo "Root partition device $ROOTPART not found, aborting resize step"
            exit 0
          fi
          sudo e2fsck -f -y $ROOTPART || true
          sudo resize2fs $ROOTPART || true

      - name: Mount partitions
        run: |
          mkdir -p mnt mnt/boot
          LOOPDEV=${{ env.LOOPDEV }}
          BOOT=${LOOPDEV}p1
          ROOT=${LOOPDEV}p2
          echo "BOOT=$BOOT" >> $GITHUB_ENV
          echo "ROOT=$ROOT" >> $GITHUB_ENV
          sudo mount $ROOT mnt
          sudo mount $BOOT mnt/boot

      - name: Apply configuration using external script
        env:
          ROOT_MOUNT: mnt
          BOOT_MOUNT: mnt/boot
          HOSTNAME: ${{ env.HOSTNAME }}
          TIMEZONE: ${{ env.TIMEZONE }}
          LOCALE: ${{ env.LOCALE }}
          KEYBOARD_LAYOUT: ${{ env.KEYBOARD_LAYOUT }}
          WIFI_COUNTRY: ${{ env.WIFI_COUNTRY }}
          DEFAULT_USER: ${{ env.DEFAULT_USER }}
          DEFAULT_PASSWORD: ${{ env.DEFAULT_PASSWORD }}
          AUTOLOGIN: ${{ env.AUTOLOGIN }}
          SHOW_MOTD: ${{ env.SHOW_MOTD }}
          RUNTIPI_AUTO_INSTALL: ${{ env.RUNTIPI_AUTO_INSTALL }}
          RUNTIPI_URL: ${{ env.RUNTIPI_URL }}
        run: |
          chmod +x ./.github/scripts/configure-image.sh
          ./.github/scripts/configure-image.sh

      - name: Sync and unmount
        run: |
          sync
          sudo umount mnt/boot || true
          sudo umount mnt || true
          sudo losetup -d ${{ env.LOOPDEV }} || true

      - name: Compress final image
        run: |
          IMG="${{ env.IMAGE_DIR }}/raspios.img"
          OUT="${{ env.IMAGE_DIR }}/runtipios.img"
          cp "$IMG" "$OUT"
          case "${{ env.COMPRESSION_FORMAT }}" in
            xz|XZ)
              xz -T0 -z -c "$OUT" > "$OUT.xz"
              ARTIFACT="$OUT.xz"
              ;;
            gz|gzip)
              gzip -c "$OUT" > "$OUT.gz"
              ARTIFACT="$OUT.gz"
              ;;
            *)
              # default to xz
              xz -T0 -z -c "$OUT" > "$OUT.xz"
              ARTIFACT="$OUT.xz"
              ;;
          esac
          echo "ARTIFACT=$ARTIFACT" >> $GITHUB_ENV

      - name: Upload compressed image
        uses: actions/upload-artifact@v4
        with:
          name: runtipios-image
          path: ${{ env.ARTIFACT }}
