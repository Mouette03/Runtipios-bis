name: Build RuntipiOS Image

on:
  # Allows manual triggering from the Actions tab
  workflow_dispatch:

  # Triggers on new release creation
  release:
    types: [created]

jobs:
  build-image:
    runs-on: ubuntu-latest
    env:
      WORKSPACE: ${{ github.workspace }}
      CONFIG_FILE: ${{ github.workspace }}/config.yml
      IMAGE_DIR: ${{ github.workspace }}/images

    steps:
      - uses: actions/checkout@v4

      - name: Parse config.yml with Python
        id: config
        run: |
          pip install pyyaml
          python -c "
          import yaml
          import os

          with open('config.yml', 'r') as f:
              config = yaml.safe_load(f)

          # Extract image name from URL
          raspios_url = config['raspios']['url']
          image_name = raspios_url.split('/')[-1]

          env_file = os.getenv('GITHUB_ENV')
          with open(env_file, 'a') as f:
              f.write(f\"RASPIOS_IMAGE_URL={raspios_url}\n\")
              f.write(f\"RASPIOS_IMAGE_NAME={image_name}\n\")
              f.write(f\"HOSTNAME={config['system']['hostname']}\n\")
              f.write(f\"TIMEZONE={config['system']['timezone']}\n\")
              f.write(f\"LOCALE={config['system']['locale']}\n\")
              f.write(f\"KEYBOARD_LAYOUT={config['system']['keyboard_layout']}\n\")
              f.write(f\"WIFI_COUNTRY={config['system']['wifi_country']}\n\")
              f.write(f\"DEFAULT_USER={config['system']['default_user']}\n\")
              f.write(f\"DEFAULT_PASSWORD={config['system']['default_password']}\n\")
              f.write(f\"IMAGE_SIZE={config['build']['image_size']}\n\")
              f.write(f\"COMPRESSION_FORMAT={config['build']['compression_format']}\n\")
              f.write(f\"RUNTIPI_AUTO_INSTALL={config['runtipi']['auto_install']}\n\")
              f.write(f\"RUNTIPI_URL={config['runtipi']['url']}\n\")
          "

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xz-utils rsync parted kpartx dosfstools e2fsprogs qemu-user-static binfmt-support util-linux openssl

      - name: Prepare images dir
        run: mkdir -p $IMAGE_DIR

      - name: Download base Raspberry Pi OS image
        run: |
          echo "Downloading $RASPIOS_URL to $IMAGE_DIR"
          wget -O $IMAGE_DIR/raspios.img.xz "$RASPIOS_URL"

      - name: Decompress base image
        run: |
          if [ ! -f "$IMAGE_DIR/raspios.img.xz" ]; then
            echo "ERROR: downloaded image missing"
            ls -l $IMAGE_DIR
            exit 1
          fi
          xz -d -k -c "$IMAGE_DIR/raspios.img.xz" > "$IMAGE_DIR/raspios.img"
          ls -lh $IMAGE_DIR

      - name: Resize image file if requested
        run: |
          IMG="$IMAGE_DIR/raspios.img"
          if [ -z "$BUILD_IMAGE_SIZE" ]; then
            echo "No build.image_size provided, keeping base image size"
            exit 0
          fi
          BYTES=$(( ${BUILD_IMAGE_SIZE} * 1024 * 1024 * 1024 ))
          CUR=$(stat -c%s "$IMG")
          echo "Current size: $CUR bytes, desired: $BYTES bytes"
          if [ "$CUR" -lt "$BYTES" ]; then
            echo "Expanding image to ${BUILD_IMAGE_SIZE}G"
            truncate -s $BYTES "$IMG"
          else
            echo "Image is already >= desired size"
          fi

      - name: Setup loop device and map partitions
        run: |
          IMG="$IMAGE_DIR/raspios.img"
          LOOPDEV=$(sudo losetup --find --show -P "$IMG")
          echo "LOOPDEV=$LOOPDEV" >> $GITHUB_ENV
          sleep 1
          echo "Partitions:"
          ls -l ${LOOPDEV}* || true

      - name: Resize root partition to fill image
        run: |
          LOOPDEV=${LOOPDEV}
          # try to resize partition 2 to 100%
          sudo parted -s $LOOPDEV resizepart 2 100% || true
          # run e2fsck and resize2fs on the partition device
          ROOTPART=${LOOPDEV}p2
          if [ ! -b "$ROOTPART" ]; then
            echo "Root partition device $ROOTPART not found, aborting resize step"
            exit 0
          fi
          sudo e2fsck -f -y $ROOTPART || true
          sudo resize2fs $ROOTPART || true

      - name: Mount partitions
        run: |
          mkdir -p mnt mnt/boot
          LOOPDEV=${LOOPDEV}
          BOOT=${LOOPDEV}p1
          ROOT=${LOOPDEV}p2
          echo "BOOT=$BOOT" >> $GITHUB_ENV
          echo "ROOT=$ROOT" >> $GITHUB_ENV
          sudo mount $ROOT mnt
          sudo mount $BOOT mnt/boot

      - name: Apply configuration using external script
        env:
          ROOT_MOUNT: mnt
          BOOT_MOUNT: mnt/boot
          HOSTNAME: ${{ steps.config.outputs.HOSTNAME }}
          TIMEZONE: ${{ steps.config.outputs.TIMEZONE }}
          LOCALE: ${{ steps.config.outputs.LOCALE }}
          KEYBOARD_LAYOUT: ${{ steps.config.outputs.KEYBOARD_LAYOUT }}
          WIFI_COUNTRY: ${{ steps.config.outputs.WIFI_COUNTRY }}
          DEFAULT_USER: ${{ steps.config.outputs.DEFAULT_USER }}
          DEFAULT_PASSWORD: ${{ steps.config.outputs.DEFAULT_PASSWORD }}
          RUNTIPI_AUTO_INSTALL: ${{ steps.config.outputs.RUNTIPI_AUTO_INSTALL }}
          RUNTIPI_URL: ${{ steps.config.outputs.RUNTIPI_URL }}
        run: |
          chmod +x ./.github/scripts/configure-image.sh
          ./.github/scripts/configure-image.sh

      - name: Sync and unmount
        run: |
          sync
          sudo umount mnt/boot || true
          sudo umount mnt || true
          sudo losetup -d $LOOPDEV || true

      - name: Unmount partitions
        if: always()
        run: |
          sudo umount /mnt/root || true
          sudo umount /mnt/boot || true
          sudo losetup -d $LOOP_DEVICE || true

      - name: Verify configuration
        run: |
          echo "--- Verifying configuration ---"
          LOOP_DEVICE=$(sudo losetup -f)
          sudo losetup -P $LOOP_DEVICE ${{ steps.config.outputs.RASPIOS_IMAGE_NAME }}
          sudo mount /dev/disk/by-partuuid/$(sudo blkid -s PARTUUID -o value ${LOOP_DEVICE}p2) /mnt/root
          sudo mount /dev/disk/by-partuuid/$(sudo blkid -s PARTUUID -o value ${LOOP_DEVICE}p1) /mnt/boot

          # Verify hostname
          if [ "$(sudo cat /mnt/root/etc/hostname)" != "${{ steps.config.outputs.HOSTNAME }}" ]; then
            echo "::error::Hostname verification failed!"
            exit 1
          fi
          echo "Hostname verification successful."

          # Verify userconf.txt
          if ! sudo grep -q "^{{ steps.config.outputs.DEFAULT_USER }}:" /mnt/boot/userconf.txt; then
            echo "::error::userconf.txt verification failed!"
            exit 1
          fi
          echo "userconf.txt verification successful."

          # Verify locale
          if ! sudo grep -q "LANG=${{ steps.config.outputs.LOCALE }}" /mnt/root/etc/default/locale; then
            echo "::error::Locale verification failed!"
            exit 1
          fi
          echo "Locale verification successful."

          # Verify keyboard
          if ! sudo grep -q 'XKBMODEL="pc105"' /mnt/root/etc/default/keyboard || ! sudo grep -q "XKBLAYOUT=${{ steps.config.outputs.KEYBOARD_LAYOUT }}" /mnt/root/etc/default/keyboard; then
            echo "::error::Keyboard verification failed!"
            exit 1
          fi
          echo "Keyboard verification successful."

          echo "--- Verification complete ---"
        
      - name: Compress final image
        run: |
          IMG="$IMAGE_DIR/raspios.img"
          OUT="$IMAGE_DIR/runtipios.img"
          cp "$IMG" "$OUT"
          case "$BUILD_COMPRESSION_FORMAT" in
            xz|XZ)
              xz -T0 -z -c "$OUT" > "$OUT.xz"
              ARTIFACT="$OUT.xz"
              ;;
            gz|gz|gzip)
              gzip -c "$OUT" > "$OUT.gz"
              ARTIFACT="$OUT.gz"
              ;;
            *)
              # default to xz
              xz -T0 -z -c "$OUT" > "$OUT.xz"
              ARTIFACT="$OUT.xz"
              ;;
          esac
          echo "ARTIFACT=$ARTIFACT" >> $GITHUB_ENV

      - name: Upload compressed image
        uses: actions/upload-artifact@v4
        with:
          name: runtipios-image
          path: images/runtipios.img.*
