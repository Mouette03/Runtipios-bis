name: "Build RuntipiOS"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - { target: "rpi5-64", name: "Raspberry Pi 5" }
          - { target: "rpi4-64", name: "Raspberry Pi 4" }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Buildroot
        run: |
          if [ ! -d "buildroot" ]; then
            git clone --depth 1 https://github.com/buildroot/buildroot.git buildroot
          fi
          ls -la buildroot/ | head

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y build-essential git curl wget bc rsync binutils bison flex unzip libssl-dev libffi-dev perl python3 cpio patchelf file lzop device-tree-compiler u-boot-tools

      - name: Configure Buildroot
        run: |
          cd buildroot
          make BR2_EXTERNAL=.. O=output ${{ matrix.target }}_defconfig
          [ -f output/.config ] || exit 1
          echo "✓ Configured for ${{ matrix.target }}"

      - name: Build Buildroot
        run: |
          cd buildroot
          echo "Building ${{ matrix.name }}..."
          make O=output -j$(nproc)
          echo "✓ Build completed"

      - name: Create artifact
        if: success()
        run: |
          mkdir -p /tmp/artifacts
          cd buildroot/output/images
          tar -czf /tmp/artifacts/runtipi-${{ matrix.target }}-${{ github.run_number }}.tar.gz .
          ls -lh /tmp/artifacts/

      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: runtipi-${{ matrix.target }}-${{ github.run_number }}
          path: /tmp/artifacts/runtipi-*.tar.gz
          retention-days: 30

      - name: Release on Tag
        if: startsWith(github.ref, 'refs/tags/') && success()
        uses: softprops/action-gh-release@v1
        with:
          files: /tmp/artifacts/runtipi-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "Build: ${{ job.status }} | Target: ${{ matrix.target }} | Run: ${{ github.run_number }}"
