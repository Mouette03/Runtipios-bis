#!/bin/bash
# RuntipiOS First Boot Setup Script
# Configures the system from config.yml

set -e

CONFIG_FILE="/boot/config.yml"
CONFIGURED_FLAG="/etc/runtipios-configured"

# Exit if already configured
if [ -f "$CONFIGURED_FLAG" ]; then
    echo "System already configured"
    exit 0
fi

echo "=== RuntipiOS First Boot Setup ==="

# Function to read config.yml
read_config() {
    local key=$1
    grep "^${key}:" "$CONFIG_FILE" | sed "s/^${key}:[[:space:]]*//" | tr -d '"' | tr -d "'"
}

# Check if config.yml exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Warning: $CONFIG_FILE not found, using defaults"
    touch "$CONFIGURED_FLAG"
    exit 0
fi

# Read configuration
HOSTNAME=$(read_config "hostname")
TIMEZONE=$(read_config "timezone")
LOCALE=$(read_config "locale")
KEYBOARD=$(read_config "keyboard")
WIFI_COUNTRY=$(read_config "wifi_country")
WIFI_SSID=$(read_config "wifi_ssid")
WIFI_PASSWORD=$(read_config "wifi_password")
USERNAME=$(read_config "username")
USER_PASSWORD=$(read_config "password")

# Set hostname
if [ -n "$HOSTNAME" ]; then
    echo "Setting hostname to: $HOSTNAME"
    hostnamectl set-hostname "$HOSTNAME"
    sed -i "s/runtipios/$HOSTNAME/g" /etc/hosts
fi

# Set timezone
if [ -n "$TIMEZONE" ]; then
    echo "Setting timezone to: $TIMEZONE"
    timedatectl set-timezone "$TIMEZONE"
fi

# Set locale
if [ -n "$LOCALE" ]; then
    echo "Setting locale to: $LOCALE"
    localectl set-locale LANG="$LOCALE"
fi

# Set keyboard layout
if [ -n "$KEYBOARD" ]; then
    echo "Setting keyboard layout to: $KEYBOARD"
    localectl set-keymap "$KEYBOARD"
fi

# Configure WiFi country
if [ -n "$WIFI_COUNTRY" ]; then
    echo "Setting WiFi country to: $WIFI_COUNTRY"
    iw reg set "$WIFI_COUNTRY"
    echo "country=$WIFI_COUNTRY" > /etc/wpa_supplicant/wpa_supplicant.conf
fi

# Create user
if [ -n "$USERNAME" ] && [ -n "$USER_PASSWORD" ]; then
    echo "Creating user: $USERNAME"
    if ! id "$USERNAME" &>/dev/null; then
        useradd -m -G wheel,docker,sudo "$USERNAME"
        echo "$USERNAME:$USER_PASSWORD" | chpasswd
        
        # Configure sudo
        echo "$USERNAME ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/$USERNAME
        chmod 0440 /etc/sudoers.d/$USERNAME
    fi
fi

# Configure WiFi if credentials provided
if [ -n "$WIFI_SSID" ] && [ -n "$WIFI_PASSWORD" ]; then
    echo "Configuring WiFi: $WIFI_SSID"
    
    cat >> /etc/wpa_supplicant/wpa_supplicant.conf << EOF

network={
    ssid="$WIFI_SSID"
    psk="$WIFI_PASSWORD"
    key_mgmt=WPA-PSK
}
EOF

    # Stop hotspot and connect to WiFi
    systemctl stop runtipios-hotspot.service 2>/dev/null || true
    systemctl disable runtipios-hotspot.service 2>/dev/null || true
    
    # Start wpa_supplicant
    wpa_supplicant -B -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf
fi

# Mark as configured
touch "$CONFIGURED_FLAG"
echo "=== Setup Complete ==="
echo "System will reboot in 10 seconds..."
sleep 10
reboot
